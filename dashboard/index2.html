<!DOCTYPE html>
<html>
    <head>
        <title>autoTuple Monitoring</title>
        <link rel="icon" type="image/png" sizes="96x96" href="images/favicon.png">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="style.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    </head>

    <body>

        <script>

            function getProgress(sample) {
                var stat = sample["status"];
                var done = 0;
                var tot = 1;

                if (stat == "new") return 0.0;
                else if (stat == "crab") {

                    if("breakdown" in sample["crab"]) {
                        done = sample["crab"]["breakdown"]["finished"];
                        tot = sample["crab"]["njobs"];
                    }
                    return 5.0 + 40.0*(done/tot);

                } else if (stat == "postprocessing") {

                    if("postprocessing" in sample) {
                        done = sample["postprocessing"]["done"];
                        tot = sample["postprocessing"]["total"];
                    }
                    return 55.0 + 35.0*(done/tot);

                } else if (stat == "done") return 100.0;
                else return -1.0;

            }

            function syntaxHighlight(json) {
                // stolen from http://stackoverflow.com/questions/4810841/how-can-i-pretty-print-json-using-javascript
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }

            function getDetails(sample) {
                var stat = sample["status"];

                var buff = "";

                if(stat == "crab") {

                    var crab = sample["crab"];
                    var breakdown = crab["breakdown"];

                    buff += "<br><span class='bad'>failed: " + breakdown["failed"] + "</span>";
                    buff += "<br>cooloff: " + breakdown["cooloff"];
                    buff += "<br>idle: " + breakdown["idle"];
                    buff += "<br>unsubmitted: " + breakdown["unsubmitted"];
                    buff += "<br>running: " + breakdown["running"];
                    buff += "<br>transferring: " + breakdown["transferring"];
                    buff += "<br>transferred: " + breakdown["transferred"];
                    buff += "<br><span class='good'>finished: " + breakdown["finished"] + "</span>";

                }

                return buff;

            }

            function parseJson(data) {
                for(var i = 0; i < data["samples"].length; i++) {
                    var sample = data["samples"][i];
                    console.log(sample);
                    var container = $("#section_1");
                    container.append("<br>");
                    container.append("<a href='#/' class='thick' onClick=\"$('#details_"+i+"').slideToggle(150)\">"+sample["dataset"]+"</a>");

                    container.append("<div class='pbar' id='pbar_"+i+"'><span id='pbartext_"+i+"' class='pbartext'></span></div>");

                    // FIXME, display:none
                    // container.append("<div id='details_"+i+"' style='display:none;'></div>");
                    container.append("<div id='details_"+i+"' class='details' ></div>");

                    $( "#pbar_"+i ).progressbar({max: 100});

                    var pct = Math.round(getProgress(sample));

                    var color = 'hsl(' + pct*1.2 + ', 70%, 50%)';
                    $("#pbar_"+i).progressbar("option","value",pct);
                    $("#pbar_"+i).find(".ui-progressbar-value").css({"background": color});
                    $("#pbartext_"+i).text(sample["status"] + " [" + pct + "%]");

                    var jsStr = syntaxHighlight(JSON.stringify(sample, undefined, 4));

                    // turn crab into a link to the dashboard
                    if(("crab" in sample) && ("uniquerequestname" in sample["crab"])) {
                        var urn = sample["crab"]["uniquerequestname"];
                        var link = "http://dashb-cms-job.cern.ch/dashboard/templates/task-analysis/#user=default&refresh=0&table=Jobs&status=&site=&tid="+urn;
                        jsStr = jsStr.replace("\"crab\":", " <a href='"+link+"' style='text-decoration: underline'>crab</a>: ");
                    }

                    // turn dataset into a link to DAS
                    jsStr = jsStr.replace("\"dataset\":", " <a href='https://cmsweb.cern.ch/das/request?view=list&limit=50&instance=prod%2Fglobal&input="+sample["dataset"]+"' style='text-decoration: underline'>dataset</a>: ");
                    $("#details_"+i).append("<pre>" + jsStr + "</pre>");


                }
            }

            var detailsVisible = true;
            function expandAll() {
                // do it this way because one guy may be reversed
                if(detailsVisible) {
                    $("#toggle_all").text("show details")
                    $("[id^=details_]").slideUp(150);
                } else {
                    $("#toggle_all").text("hide details")
                    $("[id^=details_]").slideDown(150);
                }
                detailsVisible = !detailsVisible;
            }

            $(function () {
                // $.getJSON("http://uaf-6.t2.ucsd.edu/~namin/dump/test.json", function(data) { parseJson(data); });
                // WOW CAN PUT EXTERNAL URLS HERE MAN!
                // $.getJSON("test.json", function(data) { parseJson(data); });
                $.getJSON("data.json", function(data) { parseJson(data); });

            })


        </script>

        <div id="topBar">
            <img class="mainlogo" src="crab.png" />
            <span class="thin">auto</span>Tupler
            <span class="thin">
                &emsp;
                <!-- <a href="#" onClick="$('#section_1').slideToggle(150)">section_1</a>&ensp;|&ensp; -->
                <a href="#" id="toggle_all" onClick="expandAll()">hide details</a>&ensp;|&ensp;
                <a href="#" onClick="$('#section_3').slideToggle(150)">section_3</a>
            </span>
        </div>
        <div id="colorstrip"></div>

        <div id="container">

            <div id="section_1" class="section"                      ></div>
            <!-- <div id="section_2" class="section" style='display:none;'></div> -->
            <div id="section_3" class="section" style='display:none;'></div>

        </div>

    </body>
</html>
